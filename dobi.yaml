meta:
  project: invo
  default: production

# Local packages for private/WIP python modules
mount=local_packages:
  bind: ../python/
  path: /opt/python

mount=venv:
  bind: .build/venv
  path: /opt/setup/.venv

env=production-env:
  files: [.env.production]

image=build-img:
  image: invo-builder
  context: .
  dockerfile: .docker/django/Dockerfile
  target: builder-base
  annotations:
    description: "Build the builder image"

image=prod-img:
  image: invo-prod
  context: .
  dockerfile: .docker/django/Dockerfile
  target: production
  tags: [latest]
  depends: [build-img]
  annotations:
    description: "Build the production image"

job=build:
  use: build-img
  mounts: [local_packages, venv]
  command: "poetry install --no-dev"

job=production:
  use: prod-img
  mounts: [venv]
  depends: [build, production-env]

# job=push:
#   command: "tag"
